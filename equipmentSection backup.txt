<?php
$myBorrows = null; 
$userId = $_SESSION['user_id'] ?? null;

if ($userId) {
    $stmt = $conn->prepare("
        SELECT br.id, br.status, br.quantity, br.start_date, br.end_date, e.name 
        FROM borrow_requests br 
        JOIN equipment e ON br.equipment_id = e.id 
        WHERE br.user_id = ?
        ORDER BY br.start_date DESC
    ");
    $stmt->bind_param("i", $userId);
    $stmt->execute();
    $myBorrows = $stmt->get_result();
}

// Fetch approved borrows for calendar blocking
$approvedBorrows = [];
$res = $conn->query("SELECT equipment_id, start_date, end_date 
                     FROM borrow_requests 
                     WHERE status = 'Approved'");
while ($row = $res->fetch_assoc()) {
    $approvedBorrows[$row['equipment_id']][] = [
        'start' => $row['start_date'],
        'end'   => $row['end_date']
    ];
}
?>
<script>
const approvedBorrows = <?= json_encode($approvedBorrows) ?>;
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("[data-equipment-id]").forEach(input => {
        const eqId = input.dataset.equipmentId;
        const reserved = approvedBorrows[eqId] || [];

        flatpickr(input, {
            dateFormat: "Y-m-d",
            disable: reserved.map(r => ({ from: r.start, to: r.end })),
            locale: { firstDayOfWeek: 1 }
        });
    });
});
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<!-- Equipment Section -->
<div id="equipment-section" class="equipment-section" style="display:none; height:90%; overflow-y:auto; padding:20px;">
    <h1 style="text-align:center; margin-bottom:25px;"><?= $isAdmin ? 'âš™ï¸ Equipment Management' : 'ðŸ“¦ Equipment Borrowing' ?></h1>

    <?php if ($isAdmin): ?>
        <!-- Admin Inventory List -->
        <h2>Inventory Overview</h2>
        <ul class="styled-list">
            <?php foreach ($equipmentData as $row): ?>
                <li>
                    <strong><?= htmlspecialchars($row['name']) ?></strong>  
                    <span><?= htmlspecialchars($row['description']) ?></span>  
                    <em>Qty: <?= $row['quantity'] ?></em>
                </li>
            <?php endforeach; ?>
        </ul>

    <?php else: ?>
        <!-- Staff Borrowing List -->
        <h2>Available Equipment</h2>
        <ul class="styled-list">
            <?php foreach ($equipmentData as $row): ?>
                <li>
                    <div class="list-item-left">
                        <strong><?= htmlspecialchars($row['name']) ?></strong>  
                        <span><?= htmlspecialchars($row['description']) ?></span>  
                        <em>Available: <?= $row['quantity'] ?></em>
                    </div>
                    <div class="list-item-right">
                        <form method="POST" class="inline-form">
                            <input type="hidden" name="request_borrow" value="1">
                            <input type="hidden" name="csrf_token" value="<?= $csrfToken ?>">
                            <input type="hidden" name="equipment_id" value="<?= $row['id'] ?>">

                            <label>Qty:</label>
                            <input type="number" name="quantity" min="1" max="<?= $row['quantity'] ?>" required>

                            <label>From:</label>
                            <input type="text" name="start_date" data-equipment-id="<?= $row['id'] ?>" required>

                            <label>To:</label>
                            <input type="text" name="end_date" data-equipment-id="<?= $row['id'] ?>" required>

                            <button type="submit" class="btn">Request</button>
                        </form>
                    </div>
                </li>
            <?php endforeach; ?>
        </ul>
    <?php endif; ?>

    <!-- Staff: My Borrowed Equipment -->
    <?php if ($isStaff && $myBorrows): ?>
        <h2>ðŸ“‹ My Borrowed Equipment</h2>
        <ul class="styled-list">
            <?php while ($b = $myBorrows->fetch_assoc()): ?>
                <li>
                    <strong><?= htmlspecialchars($b['name']) ?></strong>  
                    <span><?= $b['start_date'] ?> â†’ <?= $b['end_date'] ?></span>  
                    <em>Qty: <?= $b['quantity'] ?> | Status: <?= htmlspecialchars($b['status']) ?></em>
                </li>
            <?php endwhile; ?>
        </ul>
    <?php endif; ?>

    <!-- Admin: Borrow Requests -->
    <?php if ($isAdmin): ?>
        <h2>ðŸ“¨ Borrow Requests</h2>
        <ul class="styled-list">
            <?php
                $requests = $conn->query("SELECT br.*, u.username, e.name 
                    FROM borrow_requests br
                    JOIN users u ON br.user_id = u.id
                    JOIN equipment e ON br.equipment_id = e.id
                    ORDER BY br.created_at DESC");
                while ($r = $requests->fetch_assoc()):
            ?>
                <li>
                    <div class="list-item-left">
                        <strong><?= htmlspecialchars($r['username']) ?></strong>  
                        <span><?= htmlspecialchars($r['name']) ?> (Qty: <?= $r['quantity'] ?>)</span>  
                        <em><?= $r['start_date'] ?> â†’ <?= $r['end_date'] ?> | <?= $r['status'] ?></em>
                    </div>
                    <div class="list-item-right">
                        <?php if ($r['status'] === 'Pending'): ?>
                            <form method="POST" style="display:inline;">
                                <input type="hidden" name="csrf_token" value="<?= $csrfToken ?>">
                                <input type="hidden" name="approve_borrow" value="1">
                                <input type="hidden" name="request_id" value="<?= $r['id'] ?>">
                                <button type="submit" class="btn success">Approve</button>
                            </form>
                            <form method="POST" style="display:inline;">
                                <input type="hidden" name="csrf_token" value="<?= $csrfToken ?>">
                                <input type="hidden" name="reject_borrow" value="1">
                                <input type="hidden" name="request_id" value="<?= $r['id'] ?>">
                                <button type="submit" class="btn danger">Reject</button>
                            </form>
                        <?php elseif ($r['status'] === 'Approved'): ?>
                            <form method="POST" style="display:inline;">
                                <input type="hidden" name="csrf_token" value="<?= $csrfToken ?>">
                                <input type="hidden" name="return_borrow" value="1">
                                <input type="hidden" name="request_id" value="<?= $r['id'] ?>">
                                <button type="submit" class="btn">Returned</button>
                            </form>
                        <?php endif; ?>
                    </div>
                </li>
            <?php endwhile; ?>
        </ul>
    <?php endif; ?>
</div>

<style>
.styled-list {
    list-style: none;
    padding: 0;
    margin: 0 0 25px 0;
}
.styled-list li {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    background: #fff;
    padding: 12px 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
}
.list-item-left {
    flex: 1;
}
.list-item-left strong {
    font-size: 1rem;
    display: block;
}
.list-item-left span {
    display: block;
    margin-top: 3px;
    color: #666;
}
.list-item-left em {
    display: block;
    margin-top: 3px;
    font-size: 0.85rem;
    color: #333;
}
.list-item-right {
    margin-left: 20px;
    text-align: right;
}
.inline-form {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
}
.inline-form label {
    font-size: 0.8rem;
    color: #555;
}
.inline-form input {
    padding: 4px;
}
.btn {
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    background: #007bff;
    color: white;
}
.btn.success { background: #28a745; }
.btn.danger { background: #dc3545; }
</style>
